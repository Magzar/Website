<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Magzar | Signalling Simulator</title>
  <link rel="stylesheet" href="serverstyles.css">
</head>
<body>

    <header>
      <h1><a href="index.html">Magzar</a></h1>
      <nav>
        <a href="index.html">Home</a>
        <a href="scr.html">SCR</a>
        <a href="csa.html">CSA</a>
        </nav>
    </header>

<h2>Mini Train Signaling Simulator</h2>
<p class="instruction">Click signals to toggle red/green and let trains pass safely.</p>
<canvas id="train-canvas" width="800" height="400"></canvas>
<p id="score">Score: 0</p>

<script>
const canvas = document.getElementById("train-canvas");
const ctx = canvas.getContext("2d");

let score = 0;
let gameOver = false;

// Tracks, stations, and signals
const tracks = [
  { y: 80, stations: [200, 400, 600], signals: [180, 380, 580] },
  { y: 180, stations: [150, 350, 550], signals: [130, 330, 530] },
  { y: 280, stations: [100, 300, 500, 700], signals: [80, 280, 480, 680] }
];

// Junction (tracks 0 and 1 cross at x=500)
const junction = { x: 500, tracks: [0,1], occupied: false };

// Trains
let trains = [
  { x: 0, y: tracks[0].y, speed: 2, stopped: false },
  { x: -200, y: tracks[1].y, speed: 2.5, stopped: false },
  { x: -400, y: tracks[2].y, speed: 3, stopped: false }
];

// Draw everything
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Draw tracks
  ctx.strokeStyle = "#555";
  ctx.lineWidth = 6;
  tracks.forEach(track => {
    ctx.beginPath();
    ctx.moveTo(0, track.y);
    ctx.lineTo(canvas.width, track.y);
    ctx.stroke();

    // Draw stations
    track.stations.forEach(st => {
      ctx.fillStyle = "#333";
      ctx.fillRect(st-15, track.y-15, 30, 30);
      ctx.strokeStyle = "#00ffaa";
      ctx.strokeRect(st-15, track.y-15, 30, 30);
    });

    // Draw signals
    track.signals.forEach(sig => {
      ctx.fillStyle = "red";
      ctx.beginPath();
      ctx.arc(sig, track.y, 10, 0, Math.PI*2);
      ctx.fill();
      ctx.shadowColor = ctx.fillStyle;
      ctx.shadowBlur = 8;
      ctx.fill();
      ctx.shadowBlur = 0;
    });
  });

  // Draw junction
  ctx.fillStyle = "#666";
  ctx.fillRect(junction.x-20, tracks[0].y-3, 40, tracks[1].y-tracks[0].y+6);

  // Draw trains
  trains.forEach(train => {
    ctx.fillStyle = "orange";
    ctx.fillRect(train.x, train.y-10, 30, 20);
  });
}

// Update train positions
function update() {
  if (gameOver) return;

  trains.forEach((train, idx) => {
    const track = tracks[idx];
    train.stopped = false;

    // Stop if reaching red signal
    track.signals.forEach(sig => {
      if (train.x + 30 >= sig && train.x <= sig + 5) {
        train.stopped = true;
      }
    });

    // Stop if reaching occupied junction
    if (junction.tracks.includes(idx)) {
      if (train.x + 30 >= junction.x && train.x <= junction.x + 40) {
        if (junction.occupied && junction.currentTrain !== idx) {
          train.stopped = true;
        } else {
          junction.occupied = true;
          junction.currentTrain = idx;
        }
      } else if (train.x > junction.x + 40 && junction.currentTrain === idx) {
        junction.occupied = false;
        junction.currentTrain = null;
      }
    }

    if (!train.stopped) train.x += train.speed;

    // Collision detection
    trains.forEach((other, j) => {
      if (idx !== j && Math.abs(train.x - other.x) < 30 && train.y === other.y) {
        gameOver = true;
        alert("ðŸš¨ Collision! Game Over. Final Score: " + score);
      }
    });

    // Check station pass
    track.stations.forEach(st => {
      if (train.x > st && !train.passedStations) train.passedStations = {};
      if (!train.passedStations[st] && train.x > st) {
        score += 1;
        train.passedStations[st] = true;
        document.getElementById("score").textContent = "Score: " + score;
      }
    });

    // Loop trains
    if (train.x > canvas.width) {
      train.x = -50;
      train.passedStations = {};
    }
  });
}

// Click signals to toggle
canvas.addEventListener("click", (e) => {
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;

  tracks.forEach(track => {
    track.signals.forEach((sig, i) => {
      const dx = mx - sig;
      const dy = my - track.y;
      if (Math.sqrt(dx*dx + dy*dy) < 15) {
        // toggle red/green
        const color = ctx.fillStyle === 'green' ? 'red' : 'green';
        ctx.fillStyle = color;
      }
    });
  });
});

// Game loop
function loop() {
  draw();
  update();
  requestAnimationFrame(loop);
}

loop();
</script>

</body>
</html>